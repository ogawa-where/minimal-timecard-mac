# MinimalTimecard - Mac向け超シンプルタイムカードアプリ

## プロジェクト概要
業務委託・インターン生・エンジニア向けの「極限まで打刻の摩擦を減らした」メニューバー常駐型タイムカードアプリ。
多機能なタスク管理は排除し、**出勤・退勤・休憩の記録のみ**に特化する。完全オフライン・ローカル完結。

## 技術スタック
- **プラットフォーム**: macOS 15.0+ (Sequoia)
- **言語**: Swift 6 (Strict Concurrency)
- **UI**: SwiftUI (MenuBarExtra API)
- **ビルドシステム**: Swift Package Manager (SPM)
- **通信・サーバー**: なし（完全ローカル）
- **データ保存**: `~/Documents/Timecard/`（イベントログ追記型）
- **Dockアイコン**: 非表示 (LSUIElement = true)

## 配布方法
- **GitHub Releases**: タグプッシュ時にGitHub Actionsで `.app` のzipをビルドし自動リリース
- **Homebrew**: カスタムTapで配布 (`brew install ogawa-where/tap/minimal-timecard`)
- **コード署名**: 当面なし（初回起動時に右クリック→開くが必要。READMEに手順記載）
- 将来的にユーザーが増えたら公式homebrew-cask申請＋Developer ID署名を検討

## プロジェクト構成
```
minimal-timecard-mac/
├── CLAUDE.md
├── Package.swift                             # SPM パッケージ定義
├── Sources/MinimalTimecard/
│   ├── MinimalTimecardApp.swift              # @main エントリポイント (MenuBarExtra)
│   ├── Resources/
│   │   └── Info.plist                        # .app バンドル用 (LSUIElement=true)
│   ├── Models/
│   │   ├── TimecardEvent.swift               # イベントデータモデル (Date, Time, Action)
│   │   └── WorkState.swift                   # 勤務状態の列挙型
│   ├── ViewModels/
│   │   └── TimecardViewModel.swift           # 状態管理・タイマー・CSV操作の中核ロジック
│   ├── Views/
│   │   ├── TimecardMenuView.swift            # メインのポップオーバーUI
│   │   └── TimerDisplayView.swift            # タイマー表示コンポーネント
│   └── Services/
│       ├── CSVService.swift                  # CSV読み書き処理
│       └── ReportService.swift               # 月次レポート集計ロジック
├── Tests/MinimalTimecardTests/
│   └── TimecardViewModelTests.swift          # テスト (CI上のXcodeで実行)
├── scripts/
│   └── package-app.sh                        # .app バンドル作成スクリプト
└── .github/workflows/
    └── release.yml                           # タグプッシュ時の自動ビルド・リリース
```

## データ設計

### ファイル構成 (`~/Documents/Timecard/`)
```
~/Documents/Timecard/
├── log.csv                  # 生ログ（全イベントの追記ファイル）
├── 2026-01_report.csv       # 月次レポート（集計済み）
├── 2026-02_report.csv
└── ...
```

### 生ログ CSV (`log.csv`)
操作が行われた事実（イベント）をCSVの末尾に追記（Append）していく。

```
Date,Time,Action
2026/02/18,10:00:00,出勤
2026/02/18,12:00:00,休憩
2026/02/18,13:00:00,再開
2026/02/18,19:00:00,退勤
```

| フィールド | フォーマット | 値 |
|-----------|------------|-----|
| Date | `yyyy/MM/dd` | 打刻日 |
| Time | `HH:mm:ss` | 打刻時刻 |
| Action | 文字列 | `出勤` / `休憩` / `再開` / `退勤` |

### 月次レポート CSV (`YYYY-MM_report.csv`)
生ログCSVから日毎に集計し、ファイルとして出力する。

```
日付,出勤,退勤,休憩時間,実働時間
2026/02/18,10:00,19:00,01:00:00,08:00:00
2026/02/19,09:30,18:00,00:45:00,07:45:00
```

| フィールド | 説明 |
|-----------|------|
| 日付 | `yyyy/MM/dd` |
| 出勤 | その日の最初の出勤時刻 (`HH:mm`) |
| 退勤 | その日の最後の退勤時刻 (`HH:mm`)。退勤なしの場合は空欄 |
| 休憩時間 | 休憩の合計時間 (`HH:mm:ss`) |
| 実働時間 | (退勤時刻 - 出勤時刻 - 休憩合計) (`HH:mm:ss`)。退勤なしの場合は空欄 |

### 月次レポート出力フロー
1. ユーザーが `[ 今月の勤務表を出力 ]` を押下
2. `log.csv` から対象月のイベントをフィルタし、日毎に集計
3. `YYYY-MM_report.csv` を出力し、Finderで該当ファイルを表示する（`NSWorkspace.shared.selectFile`）
4. 確認ダイアログ: **「ログファイルを削除しますか？」**
   - **削除する**: `log.csv` を削除する
   - **残す**: `log.csv` はそのまま維持する

※ ログを残した場合、何度でも同じ月のレポートを再出力できる。
ユーザーが「この月は完了」と判断したタイミングでログを削除する運用を想定。

## 状態遷移

```
              出勤
 [未出勤] ─────────→ [勤務中]
    ↑                  ↕ 休憩/再開
    │                [休憩中]
    │                  │
    └──── 退勤 ────────┘ (勤務中・休憩中どちらからも退勤可能)
```

### 3つの状態と画面仕様

#### 状態1: 未出勤 (idle)
- **タイマー表示**: `00:00:00`
- **ボタン**: `[ 出勤 ]` のみ
- **遷移**: 出勤 → 勤務中

#### 状態2: 勤務中 (working)
- **タイマー表示**: 実働時間のカウントアップ（出勤からの経過時間 - 休憩合計時間）
- **ボタン**: `[ 休憩 ]` `[ 退勤 ]`
- **遷移**: 休憩 → 休憩中 / 退勤 → 未出勤

#### 状態3: 休憩中 (onBreak)
- **タイマー表示**: タイマー停止、グレーアウト表示で休憩中であることを視覚的に示す
- **ボタン**: `[ 再開 ]` `[ 退勤 ]`
- **遷移**: 再開 → 勤務中 / 退勤 → 未出勤

### メニューバーアイコン
- SF Symbols の `clock` 系アイコンを使用
- 状態に応じてアイコンを変更しても良い（例: 勤務中は `clock.fill`）

## 実装上の重要要件

### 1. アプリ起動時の状態復元
- アプリ起動時に `log.csv` の末尾から読み込み、最後のイベントに基づいて状態を復元する
- タイマー表示も正確に復元する（出勤時刻と休憩の合計時間から現在の実働時間を算出）
- CSVファイルが存在しない場合はファイルとディレクトリを自動生成し、未出勤状態で起動

### 2. 日跨ぎ対応
- 退勤するまでは日付が変わっても同じ勤務セッションとして継続する
- 退勤イベントは実際に退勤ボタンを押した日時で記録する
- 深夜勤務にも対応可能な設計とする

### 3. 無限休憩の許容
- 1日の間に何度でも「休憩」と「再開」を繰り返せること
- 休憩の合計時間は全ての休憩区間を合算して算出する

### 4. タイマー計算ロジック
```
実働時間 = 現在時刻 - 出勤時刻 - 休憩合計時間
休憩合計時間 = Σ (各休憩の終了時刻 - 各休憩の開始時刻)
※ 現在休憩中の場合、進行中の休憩は合計に含めず、タイマーを停止表示する
```

### 5. CSV操作の堅牢性
- 書き込みは常にAppend（追記）のみ
- ファイルI/Oエラー時はユーザーに通知する
- CSVファイルが破損している場合（パースエラー）はエラーを表示し、安全に初期状態で起動する

### 6. 月次レポート出力
- メニュー内に `[ 今月の勤務表を出力 ]` ボタンを設置
- 生ログCSVを読み込み、日毎に集計したCSVファイルを `~/Documents/Timecard/YYYY-MM_report.csv` に出力
- 出力後、ログ削除の確認ダイアログを表示（上記「月次レポート出力フロー」参照）
- 出力完了後、Finderで該当ファイルを表示する

## コーディング規約
- Swift 6 の Strict Concurrency に準拠する
- SwiftUI のデータフローに従い、`@Observable` マクロを使用する
- エラーハンドリングは `do-catch` で適切に処理し、ユーザーに通知する
- 日本語のAction値はコード内で `enum` として型安全に扱う
- 日時のフォーマットには `DateFormatter` を使用し、ロケールを明示的に設定する（`Locale(identifier: "ja_JP")`）

## ブランチ戦略
- `main`: リリース可能な安定版
- `develop`: 開発ブランチ（通常の作業はここで行う）
- 機能追加時は `develop` から作業し、完了後 `main` にマージ

## ビルド・実行
```bash
# デバッグビルド
swift build

# リリースビルド
swift build -c release

# .app バンドル作成（リリース）
./scripts/package-app.sh release

# .app バンドル作成（デバッグ）
./scripts/package-app.sh debug

# テスト（Xcode が必要。CI上で実行）
swift test

# 開発中の実行（メニューバーに常駐する。Ctrl+C で終了）
swift run
```
